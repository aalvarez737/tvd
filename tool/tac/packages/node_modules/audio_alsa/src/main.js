'use strict';

var assert = require('assert');
var childp = require('child_process');
var tvdutil = require('tvdutil');

function amixer( args, cb ) {
	assert( tvdutil.isFile('/usr/bin/amixer') );
	var proc = childp.spawn('amixer', args);

	proc.on('error', function(err) {
		log.error( 'Audio', 'Fail to execute amixer command! error=%s', err.message );
		cb(err);
	});

	proc.on('close', function (exitCode) {
		var err;
		if (exitCode) {
			err = new Error( 'Unknown error' );
		}
		cb(err);
	});
}

function AudioService(ctrl) {
	if (!ctrl) {
		ctrl = 'Master';
	}
	var self = {};
	var unmutedVolume = '50%';

	self.name = function() {
		return 'Alsa';
	};

	self.setVolume = function( vol, cb ) {
		unmutedVolume = vol + '%';
		amixer(['set', ctrl, unmutedVolume], cb );
	};

	self.mute = function( needMute, cb ) {
		amixer(['set', ctrl, needMute ? '0%' : unmutedVolume], cb);
	};

	return Object.freeze(self);
}

module.exports = AudioService;
