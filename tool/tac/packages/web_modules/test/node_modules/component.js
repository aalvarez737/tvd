"use strict";

var os = require('os');
var path = require('path');
var bPromise = require('bluebird');
var fs = bPromise.promisifyAll( require('fs') );
var mktemp = bPromise.promisifyAll( require('mktemp') );

function Component( fName, modExports ) {
	var tmpFile;

	var self = {};
	self.create = function() {
		return fs.readFileAsync( fName )
			.then(function(data) {
				let content = "'use strict';\n";
				content += data.toString();
				if (typeof modExports === 'string') {
					content += '\nmodule.exports = ' + modExports + ';\n';
				}
				else if (typeof modExports === 'object') {
					modExports.forEach(function(exp) {
						content += '\nmodule.exports.' + exp + ' = ' + exp + ';\n';
					});
				}
				else {
					throw new Error( 'Invalid export: type=' + (typeof modExports) );
				}

				return mktemp.createFileAsync( path.join(os.tmpdir(),'shell_XXXXXX.js' ) )
					.then( function (tmp) {
						tmpFile = tmp;
						return fs.writeFileAsync( tmpFile, content );
					});
			})
//			.then( () => console.log( 'module=%s', tmpFile ) )
			.then( () => require(tmpFile) )
			.catch( function(err) {
				console.log( 'Error: err=%s, file=%s', err.message, tmpFile );
				throw err;
			});
	};

	self.destroy = function() {
		//fs.unlinkSync( tmpFile );
	};

	return self;
}

module.exports = Component
