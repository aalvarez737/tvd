'use strict';

var assert = require('assert');
var childp = require('child_process');
var Mocks = require('mocks');

var Pulse = require('../src/main');

describe('Pulse', function() {
	var reg;

	beforeEach(function() {
		reg = Mocks.init('silly');
	});

	afterEach(function() {
		Mocks.fin();
	});

	describe('Constructor', function() {
		it('should construct a audio Pulse implementation', function() {
			var pulse = new Pulse();
			assert( pulse );
			assert( pulse.setVolume );
			assert( pulse.mute );
		});

		it('should construct a audio Pulse implementation with the sink to use', function() {
			var pulse = new Pulse(0);
			assert( pulse );
			assert( pulse.setVolume );
			assert( pulse.mute );
		});

		it('should construct a audio Pulse implementation with a RO homedir', function() {
			var homedir = process.env.HOME;
			process.env.HOME = '/';
			var pulse = new Pulse(0);
			assert( pulse );
			assert( pulse.setVolume );
			assert( pulse.mute );
			process.env.HOME = homedir;
		});

		it('should construct a audio Pulse implementation with a volume conversion', function() {
			function realVol(vol) {
				return ""+Math.floor(-0.005127707476 * Math.pow(vol,2) + 1.672824315 * vol + 13.82957457)+"%";
			}
			var pulse = new Pulse(0,realVol);
			assert( pulse );
			assert( pulse.setVolume );
			assert( pulse.mute );
		});
	});

	describe('methods for pulse', function() {
		var pulse = null;

		beforeEach(function() {
			pulse = new Pulse();
		});

		afterEach(function() {
			pulse = null;
		});

		it('should return name correctly', function() {
			assert.equal( pulse.name(), 'Pulse' );
		});

		it('should set/get master volume to 100%', function (done) {
			pulse.setVolume( 100, function(err) {
				assert(!err);
				done();
			});
		});

		it('should set master volume and get error', function (done) {
			var old = childp.spawn;
			var curSpawn = null;
			childp.spawn = function( /*cmd, args*/ ) {
				var self = {};
				self.signals = {};
				self.on = function(sig,cb) {
					self.signals[sig] = cb;
				};
				self.removeListener = function(sig/*, cb*/) {
					delete self.signals[sig];
				};
				curSpawn = self;
				return self;
			};

			pulse.setVolume( 100, function(err) {
				assert(err);
				assert.equal( err.message, 'pepe' );
				childp.spawn = old;
				done();
			});

			assert(curSpawn);
			curSpawn.signals.error( new Error( 'pepe' ) );
		});

		it('should check exit code', function (done) {
			var old = childp.spawn;
			var curSpawn = null;
			childp.spawn = function( /*cmd, args*/ ) {
				var self = {};
				self.signals = {};
				self.on = function(sig,cb) {
					self.signals[sig] = cb;
				};
				self.removeListener = function(sig/*, cb*/) {
					delete self.signals[sig];
				};
				curSpawn = self;
				return self;
			};

			pulse.setVolume( 100, function(err) {
				assert(err);
				assert.equal( err.message, 'Unknown error' );
				childp.spawn = old;
				done();
			});

			assert(curSpawn);
			curSpawn.signals.close( 1 );
		});

		it('should mute/unmute master', function (done) {
			pulse.mute( true, function (err) {
				assert( !err );
				pulse.mute( false, function (err) {
					assert( !err );
					done();
				});
			});
		});
	});
});
